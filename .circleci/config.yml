docker-images-matrix:
  executor: &images-executor-defaults
    machine: true
    working_directory: ~/docker
  attach_step: &images-attach-workspace
    attach_workspace:
      at: ~/
  persist_step: &images-persist-workspace
    persist_to_workspace:
      root: ~/
      paths:
        - docker
  master-workflow: &images-master-workflow
    filters:
      branches:
        only: master
    requires:
      - docker-checkout
  publish-workflow: &images-publish-workflow
    filters:
      branches:
        only: master
    requires:
      - docker-build

version: 2.1

executors:
  ariang:
    <<: *images-executor-defaults
    environment:
      PROJECT_PATH: ariang
      DOCKERFILE_PATH: Dockerfile
      DOCKER_REPO: leodagan/ariang
  aria2:
    <<: *images-executor-defaults
    environment:
      PROJECT_PATH: aria2
      DOCKERFILE_PATH: Dockerfile
      DOCKER_REPO: leodagan/aria2
  pptp:
    <<: *images-executor-defaults
    environment:
      PROJECT_PATH: pptp
      DOCKERFILE_PATH: Dockerfile
      DOCKER_REPO: leodagan/pptp

jobs:
  docker-checkout:
    parameters:
      runner:
        type: executor
    executor: << parameters.runner >>
    steps:
      - *images-attach-workspace
      - checkout
      - run: |
          if [ "$(git --no-pager log -1 --format=format:%H --full-diff "${PROJECT_PATH}")" != "${CIRCLE_SHA1}"  ]; then
            echo "No changes in ${PROJECT_PATH} repository, skipping step..."
            circleci-agent step halt
          fi
      - *images-persist-workspace

  docker-build:
    parameters:
      docker-tag:
        type: string
      runner:
        type: executor
    executor: << parameters.runner >>
    steps:
      - *images-attach-workspace
      - run: |
          if [ ! -e "${PROJECT_PATH}" ]; then circleci-agent step halt; fi
      - run: |
          cd "${PROJECT_PATH}"
          ./hooks/build
      - run: |
          cd "${PROJECT_PATH}"
          ./hooks/test
      - run: |
          cd "${PROJECT_PATH}"
          echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
          ./hooks/push
    environment:
      DOCKER_TAG: << parameters.docker-tag >>

  docker-publish:
    parameters:
      badge-hook:
        type: string
      runner:
        type: executor
    executor: << parameters.runner >>
    steps:
      - *images-attach-workspace
      - run: |
          if [ ! -e "${PROJECT_PATH}" ]; then circleci-agent step halt; fi
      - run: curl -X POST '<< parameters.badge-hook >>'

workflows:
  pptp:
    jobs:
      - docker-checkout:
          runner: pptp
      - docker-build:
          runner: pptp
          docker-tag: latest
          <<: *images-master-workflow
      - docker-build:
          runner: pptp
          docker-tag: latest-arm32v6
          <<: *images-master-workflow
      - docker-build:
          runner: pptp
          docker-tag: latest-arm32v7
          <<: *images-master-workflow
      - docker-build:
          runner: pptp
          docker-tag: latest-arm64v8
          <<: *images-master-workflow
      - docker-build:
          runner: pptp
          docker-tag: edge
          <<: *images-master-workflow
      - docker-build:
          runner: pptp
          docker-tag: edge-arm32v6
          <<: *images-master-workflow
      - docker-build:
          runner: pptp
          docker-tag: edge-arm32v7
          <<: *images-master-workflow
      - docker-build:
          runner: pptp
          docker-tag: edge-arm64v8
          <<: *images-master-workflow
      - docker-publish:
          runner: ariang
          badge-hook: https://hooks.microbadger.com/images/leodagan/pptp/Oaje7NSXWyvxNuW--LAn11_gqoE=
          <<: *images-publish-workflow
  ariang:
    jobs:
      - docker-checkout:
          runner: ariang
      - docker-build:
          runner: ariang
          docker-tag: latest
          <<: *images-master-workflow
      - docker-build:
          runner: ariang
          docker-tag: latest-arm32v6
          <<: *images-master-workflow
      - docker-build:
          runner: ariang
          docker-tag: latest-arm32v7
          <<: *images-master-workflow
      - docker-build:
          runner: ariang
          docker-tag: latest-arm64v8
          <<: *images-master-workflow
      - docker-build:
          runner: ariang
          docker-tag: edge
          <<: *images-master-workflow
      - docker-build:
          runner: ariang
          docker-tag: edge-arm32v6
          <<: *images-master-workflow
      - docker-build:
          runner: ariang
          docker-tag: edge-arm32v7
          <<: *images-master-workflow
      - docker-build:
          runner: ariang
          docker-tag: edge-arm64v8
          <<: *images-master-workflow
      - docker-publish:
          runner: ariang
          badge-hook: https://hooks.microbadger.com/images/leodagan/ariang/xcN8593pqjchKNuVtW7oCgFdebU=
          <<: *images-publish-workflow
  aria2:
    jobs:
      - docker-checkout:
          runner: aria2
      - docker-build:
          runner: aria2
          docker-tag: latest
          <<: *images-master-workflow
      - docker-build:
          runner: aria2
          docker-tag: latest-arm32v6
          <<: *images-master-workflow
      - docker-build:
          runner: aria2
          docker-tag: latest-arm32v7
          <<: *images-master-workflow
      - docker-build:
          runner: aria2
          docker-tag: latest-arm64v8
          <<: *images-master-workflow
      - docker-build:
          runner: aria2
          docker-tag: edge
          <<: *images-master-workflow
      - docker-build:
          runner: aria2
          docker-tag: edge-arm32v6
          <<: *images-master-workflow
      - docker-build:
          runner: aria2
          docker-tag: edge-arm32v7
          <<: *images-master-workflow
      - docker-build:
          runner: aria2
          docker-tag: edge-arm64v8
          <<: *images-master-workflow
      - docker-publish:
          runner: aria2
          badge-hook: https://hooks.microbadger.com/images/leodagan/aria2/iUEnHO2bAU5Nk48i4D6VpzzOlMQ=
          <<: *images-publish-workflow

